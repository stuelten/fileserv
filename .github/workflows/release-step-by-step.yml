name: Release (step-by-step)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty for auto-increase)'
        required: false
        default: ''
      skip_native:
        description: 'Skip native builds'
        type: boolean
        default: false

jobs:
  prepare:
    name: Prepare correct version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_increase.outputs.version }}
      next_snapshot: ${{ steps.version_increase.outputs.next_snapshot }}
      skip_native: ${{ github.event.inputs.skip_native }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Increase Version
        id: version_increase
        run: |
          chmod +x bin/version-get.sh
          chmod +x bin/version-increase-semver.sh
          echo "Current version:  $(./bin/version-get.sh)"

          VERSION_INCREASED=$(./bin/version-increase-semver.sh)
          VERSION_INPUT="${{ github.event.inputs.version }}"
          VERSION=${VERSION_INPUT:-$VERSION_INCREASED}
          
          # Calculate next snapshot version (assuming minor increment for the next development cycle)
          NEXT_VERSION=$(./bin/version-increase-semver.sh minor)
          NEXT_SNAPSHOT="${NEXT_VERSION}-SNAPSHOT"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "next_snapshot=$NEXT_SNAPSHOT" >> $GITHUB_OUTPUT
          echo "### Release Version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "### Next Snapshot: $NEXT_SNAPSHOT" >> $GITHUB_STEP_SUMMARY

  create-release-branch:
    name: Create Release Branch
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create and push release branch
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          BRANCH="release-v$VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH"
          
          chmod +x bin/version-set.sh
          ./bin/version-set.sh "$VERSION"
          
          git add "**/pom.xml" "pom.xml" VERSION
          git commit -m "chore: release version $VERSION"
          git push origin "$BRANCH" --force
          
          echo "### Branch: $BRANCH" >> $GITHUB_STEP_SUMMARY

  build-java:
    name: Build Java Parts
    needs: [ prepare, create-release-branch ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw --batch-mode -DskipTests install

      - name: Upload JARs
        uses: actions/upload-artifact@v6
        with:
          name: fileserv-java-artifacts-${{ needs.prepare.outputs.version }}
          path: |
            **/target/classes
            **/target/*.jar
            !**/target/*-sources.jar
            !**/target/*-javadoc.jar

      - name: Report results
        run: |
          echo "### Java Parts build:" >> $GITHUB_STEP_SUMMARY
          echo "#### JARs" >> $GITHUB_STEP_SUMMARY
          echo "| JARs | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          find results/jars -name "*.jar" -type f | sort | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY

  build-java-shaded-jars:
    name: Build Java Parts as All-in-One JARs
    needs: [ prepare, create-release-branch, build-java ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download Java Build artifacts
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-artifacts-${{ needs.prepare.outputs.version }}

      - name: Build with Maven
        run: ./mvnw --batch-mode -DskipTests -Pshaded-jar install

      - name: Upload JARs
        uses: actions/upload-artifact@v6
        with:
          name: fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}
          path: |
            **/target/*.jar
            !**/target/*-sources.jar
            !**/target/*-javadoc.jar

      - name: Report results
        run: |
          echo "### Java shaded-jars build:" >> $GITHUB_STEP_SUMMARY
          echo "| Shaded JAR | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          find . -iname '*.jar' -type f | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY

  build-native:
    name: Build Native Binaries
    needs: [ prepare, create-release-branch, build-java-shaded-jars ]
    if: needs.prepare.outputs.skip_native != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: 'true'
          cache: 'maven'

      - name: Download Java Build artifacts
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-artifacts-${{ needs.prepare.outputs.version }}

      - name: Download Java Shaded Jars
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}

      - name: Build Native Binaries
        run: ./mvnw --batch-mode -DskipTests -Pnative install

      - name: Upload Native Binaries
        uses: actions/upload-artifact@v6
        with:
          name: fileserv-native-binaries-${{ needs.prepare.outputs.version }}
          path: |
            fileserv-app/fileserv-app/target/fileserv-app
            fileserv-auth-file/fileserv-auth-file-smbpasswd/target/fileserv-smbpasswd
            fileserv-test-generate-hierarchy/target/fileserv-test-generate-hierarchy
            fileserv-test-webdav/target/fileserv-test-webdav

      - name: Report results
        run: |
          echo "### Native Binaries build:" >> $GITHUB_STEP_SUMMARY
          echo "| Native Binary | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          # List the specific binaries we just built
          FILES="fileserv-app/fileserv-app/target/fileserv-app
                 fileserv-auth-file/fileserv-auth-file-smbpasswd/target/fileserv-smbpasswd
                 fileserv-test-generate-hierarchy/target/fileserv-test-generate-hierarchy
                 fileserv-test-webdav/target/fileserv-test-webdav"
          for bin in $FILES; do
            if [ -f "$bin" ]; then
              SIZE=$(ls -sk "$bin" | cut -d' ' -f1)
              echo "| $bin | $SIZE |"
            fi
          done >> $GITHUB_STEP_SUMMARY

  build-docker:
    name: Build Docker Containers
    needs: [ prepare, create-release-branch, build-java-shaded-jars ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Download Java Shaded Jars
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}

      - name: Build Docker Image
        run: |
          docker build -t fileserv-app .

  quick-tests-mvn:
    name: Run Quick Tests (mvn)
    needs: [ prepare, create-release-branch, build-java ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download JARs
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-artifacts-${{ needs.prepare.outputs.version }}

      - name: Run Maven Tests
        run: ./mvnw --batch-mode test

  quick-tests-bash:
    name: Run Quick Tests (bash)
    needs: [ prepare, create-release-branch, build-java ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download JARs
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-artifacts-${{ needs.prepare.outputs.version }}

      - name: Run Bash Test Scripts
        run: |
          chmod +x test/run-test-scripts.sh
          ./test/run-test-scripts.sh -q

  long-running-tests:
    name: Start Long-Running Tests asynchronously
    needs: [ prepare, create-release-branch, build-java-shaded-jars, build-docker ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download JARs
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}

      - name: Run Full Test Setup
        run: |
          chmod +x test/run-full-test.sh
          # We need to make sure build.sh inside run-full-test.sh doesn't try to rebuild everything if possible
          ./test/run-full-test.sh -q --skipBuild

      - name: Check container logs on failure
        if: failure()
        run: |
          docker compose logs || docker-compose logs || true

  report-results:
    name: Report Build Results
    needs: [ prepare, build-java, build-java-shaded-jars, build-native ]
    if: always() && needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Download JARs
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-artifacts-${{ needs.prepare.outputs.version }}
          path: results/jars

      - name: Download Shaded JARs
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}
          path: results/shaded-jars

      - name: Download Native Binaries
        if: needs.prepare.outputs.skip_native != 'true'
        uses: actions/download-artifact@v7
        with:
          name: fileserv-native-binaries-${{ needs.prepare.outputs.version }}
          path: results/native

      - name: Report Results
        run: |
          echo "### Build Results for Version ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "#### JARs" >> $GITHUB_STEP_SUMMARY
          echo "| JARs | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          find results/jars -name "*.jar" -type f | sort | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY

          echo "#### Shaded JARs" >> $GITHUB_STEP_SUMMARY
          echo "| Shaded JAR | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          find results/shaded-jars -name "*.jar" -type f | sort | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.prepare.outputs.skip_native }}" != "true" ]; then
            echo "#### Native Binaries" >> $GITHUB_STEP_SUMMARY
            echo "| Native Binary | Size (KB) |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            find results/native -type f | sort | while read bin ; do
              SIZE=$(ls -sk "$bin" | cut -d' ' -f1)
              echo "| $bin | $SIZE |"
            done >> $GITHUB_STEP_SUMMARY
          fi

  release:
    name: Release
    needs: [ prepare, create-release-branch, build-java, build-java-shaded-jars, build-native, quick-tests-bash, quick-tests-mvn, report-results ]
    if: always() && needs.prepare.result == 'success' && needs.create-release-branch.result == 'success' && needs.build-java.result == 'success' && needs.build-java-shaded-jars.result == 'success' && (needs.prepare.outputs.skip_native == 'true' || needs.build-native.result == 'success') && needs.quick-tests-bash.result == 'success' && needs.quick-tests-mvn.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: Download JARs
        uses: actions/download-artifact@v7
        with:
          name: fileserv-java-artifacts-${{ needs.prepare.outputs.version }}

      - name: Download Native Binaries
        if: needs.prepare.outputs.skip_native != 'true'
        uses: actions/download-artifact@v7
        with:
          name: fileserv-native-binaries-${{ needs.prepare.outputs.version }}
          path: ./native-binaries

      - name: Prepare Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "v$VERSION" -m "Version $VERSION"
          git push origin "v$VERSION"
          
          RELEASE_ARGS=(create "v$VERSION" --title "Version $VERSION" --notes "Automated release of version $VERSION")

          if [ "${{ needs.prepare.outputs.skip_native }}" != "true" ]; then
            # Move native binaries to expected locations for gh release
            mkdir -p fileserv-auth-file/fileserv-auth-file-smbpasswd/target/
            mkdir -p fileserv-test-generate-hierarchy/target/
            mkdir -p fileserv-test-webdav/target/
            
            cp ./native-binaries/fileserv-auth-file/fileserv-auth-file-smbpasswd/target/fileserv-smbpasswd fileserv-auth-file/fileserv-auth-file-smbpasswd/target/
            cp ./native-binaries/fileserv-test-generate-hierarchy/target/fileserv-test-generate-hierarchy fileserv-test-generate-hierarchy/target/
            cp ./native-binaries/fileserv-test-webdav/target/fileserv-test-webdav fileserv-test-webdav/target/

            RELEASE_ARGS+=("fileserv-auth-file/fileserv-auth-file-smbpasswd/target/fileserv-smbpasswd")
            RELEASE_ARGS+=("fileserv-test-generate-hierarchy/target/fileserv-test-generate-hierarchy")
            RELEASE_ARGS+=("fileserv-test-webdav/target/fileserv-test-webdav")
          fi
          
          gh release "${RELEASE_ARGS[@]}"

  post-release:
    name: Post Release
    needs: [ prepare, release ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: Bump new snapshot version
        id: version_bump
        run: |
          chmod +x bin/version-get.sh
          chmod +x bin/version-increase-semver.sh
          chmod +x bin/version-set-snapshot.sh
          echo "Current version:  $(./bin/version-get.sh)"

          NEXT_SNAPSHOT=${{ needs.prepare.outputs.next_snapshot }}
          echo "Next snapshot: $NEXT_SNAPSHOT"
          ./bin/version-set-snapshot.sh $NEXT_SNAPSHOT

      - name: Push new version
        id: version_push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "**/pom.xml" "pom.xml" VERSION
          git commit -m "chore: Bump snapshot version to ${{ needs.prepare.outputs.next_snapshot }}"
          git push origin main
