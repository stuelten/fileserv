name: "Release Artifacts"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (leave empty for auto-increase)"
        required: false
        default: ""
      trigger_native:
        description: "Trigger native builds asynchronously"
        type: boolean
        default: true
  push:
    branches:
      - main

jobs:
  prepare:
    name: "Prepare correct version"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_increase.outputs.version }}
      next_snapshot: ${{ steps.version_increase.outputs.next_snapshot }}
      trigger_native: ${{ steps.version_increase.outputs.trigger_native }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "Increase Version"
        id: version_increase
        run: |
          chmod +x bin/version-get.sh
          chmod +x bin/version-increase-semver.sh
          echo "Current version:  $(./bin/version-get.sh)"

          VERSION_INCREASED=$(./bin/version-increase-semver.sh)
          VERSION_INPUT="${{ github.event.inputs.version }}"
          VERSION=${VERSION_INPUT:-$VERSION_INCREASED}
          
          TRIGGER_NATIVE="${{ github.event.inputs.trigger_native }}"
          if [ -z "$TRIGGER_NATIVE" ]; then
            TRIGGER_NATIVE="true"
          fi
          
          # Calculate next snapshot version based on the released version
          # Split version into components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEXT_VERSION="$MAJOR.$((MINOR + 1)).0"
          NEXT_SNAPSHOT="${NEXT_VERSION}-SNAPSHOT"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "next_snapshot=$NEXT_SNAPSHOT" >> $GITHUB_OUTPUT
          echo "trigger_native=$TRIGGER_NATIVE" >> $GITHUB_OUTPUT
          echo "### Release Version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "### Next Snapshot: $NEXT_SNAPSHOT" >> $GITHUB_STEP_SUMMARY

  create-release-branch:
    name: "Create Release Branch"
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "Create and push release branch"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x bin/*.sh
          ./bin/release-branch-create.sh --push "${{ needs.prepare.outputs.version }}"
          echo "### Branch: release-v${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  build-java:
    name: "Build Java Parts"
    needs: [ prepare, create-release-branch ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: "Build with Maven"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw --batch-mode -s ${{ github.workspace }}/settings.xml -DskipTests install

      - name: "Upload JARs"
        uses: actions/upload-artifact@v6
        with:
          name: "fileserv-java-artifacts-${{ needs.prepare.outputs.version }}"
          path: |
            **/target/classes
            **/target/*.jar
            !**/target/*-sources.jar
            !**/target/*-javadoc.jar

      - name: "Report results"
        run: |
          echo "### Java Parts build:" >> $GITHUB_STEP_SUMMARY
          echo "| JARs | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          find . -name "*.jar" -type f | sort | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY

  build-java-shaded-jars:
    name: "Build Java Parts as All-in-One JARs"
    needs: [ prepare, create-release-branch, build-java ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: "Download Java Build artifacts"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-artifacts-${{ needs.prepare.outputs.version }}"

      - name: "Build with Maven"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw --batch-mode -s ${{ github.workspace }}/settings.xml -DskipTests -Pshaded-jar install

      - name: "Upload JARs"
        uses: actions/upload-artifact@v6
        with:
          name: "fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}"
          path: |
            **/target/*.jar
            !**/target/*-sources.jar
            !**/target/*-javadoc.jar

      - name: "Report results"
        run: |
          echo "### Java shaded-jars build:" >> $GITHUB_STEP_SUMMARY
          echo "| Shaded JAR | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          find . -iname '*.jar' -type f | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY


  build-docker:
    name: "Build and Push Docker Containers"
    needs: [ prepare, create-release-branch, build-java-shaded-jars ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: "Download Java Shaded Jars"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}"

      - name: "Log in to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build and Push Docker Image"
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          IMAGE_ID=ghcr.io/${{ github.repository }}/fileserv-app
          
          # Convert IMAGE_ID to lowercase
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          
          docker build -t $IMAGE_ID:$VERSION -t $IMAGE_ID:latest .
          docker push $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:latest

  quick-tests-mvn:
    name: "Run Quick Tests (mvn)"
    needs: [ prepare, create-release-branch, build-java ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: "Download JARs"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-artifacts-${{ needs.prepare.outputs.version }}"

      - name: "Run Maven Tests"
        run: ./mvnw --batch-mode test

  quick-tests-bash:
    name: "Run Quick Tests (bash)"
    needs: [ prepare, create-release-branch, build-java ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: "Download JARs"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-artifacts-${{ needs.prepare.outputs.version }}"

      - name: "Run Bash Test Scripts"
        run: |
          chmod +x test/run-test-scripts.sh
          ./test/run-test-scripts.sh -q

  long-running-tests:
    name: "Start Long-Running Tests asynchronously"
    needs: [ prepare, create-release-branch, build-java-shaded-jars, build-docker ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: "Download JARs"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}"

      - name: "Run Full Test Setup"
        run: |
          chmod +x test/run-full-test.sh
          # Test without rebuilding everything
          ./test/run-full-test.sh -q --skipBuild

      - name: "Check container logs on failure"
        if: failure()
        run: |
          docker compose logs || docker-compose logs || true

  report-results:
    name: "Report Build Results"
    needs: [ prepare, build-java, build-java-shaded-jars, build-docker ]
    if: always() && needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: "Report Results"
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          echo "### Build Results for Version $VERSION" >> $GITHUB_STEP_SUMMARY
          
          IMAGE_ID=ghcr.io/${{ github.repository }}/fileserv-app
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          
          echo "#### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image:** \`$IMAGE_ID:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Maven Packages:** [GitHub Packages](https://github.com/${{ github.repository }}/packages)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "Download JARs"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-artifacts-${{ needs.prepare.outputs.version }}"
          path: results/jars

      - name: "Download Shaded JARs"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-shaded-jars-${{ needs.prepare.outputs.version }}"
          path: results/shaded-jars

      - name: "Report Results"
        run: |
          echo "#### Artifact Details" >> $GITHUB_STEP_SUMMARY
          echo "#### JARs" >> $GITHUB_STEP_SUMMARY
          echo "| JARs | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          find results/jars -name "*.jar" -type f | sort | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY

          echo "#### Shaded JARs" >> $GITHUB_STEP_SUMMARY
          echo "| Shaded JAR | Size (KB) |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          find results/shaded-jars -name "*.jar" -type f | sort | while read jar ; do
            SIZE=$(ls -sk "$jar" | cut -d' ' -f1)
            echo "| $jar | $SIZE |"
          done >> $GITHUB_STEP_SUMMARY

  release:
    name: "Release"
    needs: [ prepare, create-release-branch, build-java, build-java-shaded-jars, quick-tests-bash, quick-tests-mvn ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: release-v${{ needs.prepare.outputs.version }}

      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: "Deploy Maven Artifacts"
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw --batch-mode -s ${{ github.workspace }}/settings.xml -DskipTests deploy

      - name: "Download JARs"
        uses: actions/download-artifact@v7
        with:
          name: "fileserv-java-artifacts-${{ needs.prepare.outputs.version }}"

      - name: "Prepare Release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x bin/*.sh
          ./bin/release-tag.sh --push "${{ needs.prepare.outputs.version }}"

  trigger-release-native-binaries:
    name: "Trigger Native Binaries Release"
    needs: [ prepare, release ]
    if: needs.prepare.outputs.trigger_native == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: actions/checkout@v6

      - name: "Trigger Workflow"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run release-native-binaries.yml -f version=${{ needs.prepare.outputs.version }}

  post-release:
    name: "Post Release"
    needs: [ prepare, release ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: "Bump new snapshot version"
        id: version_bump
        run: |
          chmod +x bin/*.sh
          ./bin/release-post.sh --push "${{ needs.prepare.outputs.next_snapshot }}"
