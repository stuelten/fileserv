name: Create Branch from Issue

# Trigger: Automatically on issue labeling or manually via workflow_dispatch
on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to create branch for'
        required: true
      use_issue_data:
        description: 'Use issue data (title/labels) instead of manual input'
        type: boolean
        default: true
      branch_type:
        description: 'Manually set branch type (feature, bugfix, docs, task) (ignored if use_issue_data is true)'
        required: false
      branch_title:
        description: 'Manually set branch title (ignored if use_issue_data is true)'
        required: false

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository to create branches
      - uses: actions/checkout@v6

      # Fetch issue data from GitHub API if use_issue_data is true
      - name: Fetch Issue Data
        if: github.event_name == 'workflow_dispatch' && inputs.use_issue_data
        id: fetch_issue
        run: |
          # Use GitHub API to get issue details
          # GITHUB_TOKEN has repo scope by default
          ISSUE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }}")
          # Extract title and labels using jq
          echo "issue_title=$(echo $ISSUE_DATA | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "issue_labels=$(echo $ISSUE_DATA | jq -r '.labels[].name' | jq -s -R 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

      # Create the branch based on collected data
      - name: Create Branch
        run: |
          # Case 1: Manual trigger with issue data
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.use_issue_data }}" == "true" ]]; then
            ISSUE_TITLE="${{ steps.fetch_issue.outputs.issue_title }}"
            LABELS="${{ steps.fetch_issue.outputs.issue_labels }}"
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
            NORMALIZED_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g')
            # Determine branch type from labels
            if echo "$LABELS" | grep -q "enhancement"; then
              BRANCH_TYPE="feature"
            elif echo "$LABELS" | grep -q "bug"; then
              BRANCH_TYPE="bugfix"
            elif echo "$LABELS" | grep -q "documentation"; then
              BRANCH_TYPE="docs"
            else
              BRANCH_TYPE="task"
            fi

          # Case 2: Manual trigger with custom data
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH_TYPE="${{ github.event.inputs.branch_type }}"
            NORMALIZED_TITLE=$(echo "${{ github.event.inputs.branch_title }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g')
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"

          # Case 3: Automatic trigger from issue event
          else
            ISSUE_NUMBER=${{ github.event.issue.number }}
            ISSUE_TITLE="${{ github.event.issue.title }}"
            LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            NORMALIZED_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g')
            if [[ $LABELS == *"enhancement"* ]]; then
              BRANCH_TYPE="feature"
            elif [[ $LABELS == *"bug"* ]]; then
              BRANCH_TYPE="bugfix"
            elif [[ $LABELS == *"documentation"* ]]; then
              BRANCH_TYPE="docs"
            else
              BRANCH_TYPE="task"
            fi
          fi

          # Create branch name and push to origin
          BRANCH_NAME="$BRANCH_TYPE/$ISSUE_NUMBER-$NORMALIZED_TITLE"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
